version: 0.2

env:
  variables:
    CLUSTER_NAME: "my-cluster"
    AWS_REGION: "ap-south-1"
    REPO_NAME: "eks_repo"
    IMAGE_TAG: "latest"
    ALB_SERVICE_ACCOUNT: "aws-load-balancer-controller"

phases:
  install:
    commands:
      - echo "Installing AWS CLI, kubectl, eksctl, and Helm..."
      - curl -sSL "https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3" | bash
      - aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_REGION

  pre_build:
    commands:
      - echo "Logging into Amazon ECR..."
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $(aws sts get-caller-identity --query Account --output text).dkr.ecr.$AWS_REGION.amazonaws.com

      - echo "Checking IAM OIDC provider for EKS..."
      - eksctl utils associate-iam-oidc-provider --region $AWS_REGION --cluster $CLUSTER_NAME --approve || echo "OIDC already exists"

      - echo "Creating IAM policy for ALB Controller..."
      - curl -o iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
      - aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam-policy.json || echo "Policy exists"
      - echo "Creating Service Account for ALB Controller..."
      - eksctl create iamserviceaccount --cluster "$CLUSTER_NAME" --namespace kube-system --name aws-load-balancer-controller --attach-policy-arn "arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):policy/AWSLoadBalancerControllerIAMPolicy" --approve --override-existing-serviceaccounts || echo "Service account already exists or failed to create."


  build:
    commands:
      - echo "Building Docker image..."
      - docker build -t $REPO_NAME:$IMAGE_TAG .
      - docker tag $REPO_NAME:$IMAGE_TAG $(aws sts get-caller-identity --query Account --output text).dkr.ecr.$AWS_REGION.amazonaws.com/$REPO_NAME:$IMAGE_TAG

  post_build:
    commands:
      - echo "Pushing Docker image to ECR..."
      - docker push $(aws sts get-caller-identity --query Account --output text).dkr.ecr.$AWS_REGION.amazonaws.com/$REPO_NAME:$IMAGE_TAG

      - echo "Adding Helm repository for ALB Controller..."
      - helm repo add eks https://aws.github.io/eks-charts
      - helm repo update

      - echo "Installing AWS Load Balancer Controller..."
      - |
        helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
          --namespace kube-system \
          --set clusterName=$CLUSTER_NAME \
          --set serviceAccount.create=false \
          --set serviceAccount.name=$ALB_SERVICE_ACCOUNT

      - echo "Deploying application to EKS..."
      - kubectl apply -f deployment.yml
      - kubectl apply -f service.yml
      - kubectl apply -f ingress.yml
